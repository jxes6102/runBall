<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="apple-touch-fullscreen" content="YES" />
<meta name="format-detection" content="telephone=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta http-equiv="Expires" content="-1" />
<meta http-equiv="pragram" content="no-cache" />

<link href="./css/style.css" type="text/css" rel="stylesheet">
<link href="./css/ball.css" type="text/css" rel="stylesheet">
<link href="./css/run.css" type="text/css" rel="stylesheet">


<title>jQuery双色球开奖扭蛋机抽奖代码 - 站长素材</title>
<!--移动端版本兼容 -->
<script type="text/javascript">
    var phoneWidth =  parseInt(window.screen.width);
    var phoneScale = phoneWidth/640;
    var ua = navigator.userAgent;
    if (/Android (\d+\.\d+)/.test(ua)){
        var version = parseFloat(RegExp.$1);
        // andriod 2.3
        if(version>2.3){
            document.write('<meta name="viewport" content="width=640, minimum-scale = '+phoneScale+', maximum-scale = '+phoneScale+', target-densitydpi=device-dpi">');
        // andriod 2.3以上
        }else{
            document.write('<meta name="viewport" content="width=640, target-densitydpi=device-dpi">');
        }
        // 其他系统
    } else {
        document.write('<meta name="viewport" content="width=640, user-scalable=no, target-densitydpi=device-dpi">');
    }
    //微信去掉下方刷新栏
    if(RegExp("MicroMessenger").test(navigator.userAgent)){
        document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
            WeixinJSBridge.call('hideToolbar');
        });
    }
</script>

<script src="./js/jquery1.8.3.min.js"></script>
</head>
<body>

<div class="niu_danji">
	<!--机器-->
	<div class="game_qu">
        <div class="game_go"></div>
        <div class="wdjifen"></div>
    </div>
    
    <!--球-->
    <div class="dan_gund"> </div>

     <!--中奖掉落-->
   <div class="medon"><img src="images/mendong.png"></div>
   <div class="zjdl ">
   		<span></span>
   </div>
    
</div>

<div class="zonj_zezc none" id="jianpin_one">
	<div class="jpzs aiqiyi tc_anima">
		<em><img src="images/close.png"></em>
		<h2 id="message"></h2>
		<!-- <div id="message"></div> -->
	</div>
</div>
<script>

//歷史紀錄
// fetch('https://wkc-admin.worldlottery.cc/graphql', {
// 	body: JSON.stringify({
// 		operationName:"drawHistory",
// 		query: "query drawHistory($code: String!) {\n  drawHistory(code: $code) {\n    issue\n    drawResult\n    drawTime\n    __typename\n  }\n}\n",
// 		variables:{code:"twklb"}
// 	}),
// 	headers: {
// 		'content-type': 'application/json' // 這一欄一定要設定！
// 	},
// 	method: 'POST',
// })
// .then(response => response.json()) // 輸出成 json
// .then(data => console.log('graphql',data))

let drawResult = ''
let allNum = 80
let cycleNo = 0
let openStatus = true
// 拿開獎數字
const getNum = async() => {
	await fetch('https://globalcaipiaokong.com/api/trial/draw-result?code=twklb&rows=1', {
		headers: {
			'content-type': 'application/json' // 這一欄一定要設定！
		},
		method: 'GET',
	})
	.then(response => response.json()) // 輸出成 json
	.then(res => {

		if(res.msg === '成功') {
			if(cycleNo === res.data[0].cycleNo) {
				openStatus = false
			}else{
				cycleNo = res.data[0].cycleNo
				openStatus = true
			}
			
			drawResult = res.data[0].drawResult
			// console.log('drawResult',drawResult)
		}

	}).catch((error) => {
		console.error("Error:", error);
	});
}
//初始化球和API
const init = async() => {
	await getNum()
	for(let i = 1;i<=allNum;i++){
		let span = document.createElement('span')
		span.className = 'qiu_' + i + ' diaol_' + i
		$('.dan_gund').append(span)
	}
	// console.log('init')
}
//掉球動作
let fallTimes = 0
const fallBall = () => {
	if(fallTimes<20){
		setTimeout(function (){
			// 掉球
			let num = drawResult.split(',')[fallTimes]
			$(".zjdl").children("span").attr('data-content',num)
			$(".zjdl").children("span").addClass("diaL_one");
			$(".zjdl").removeClass("none").addClass("dila_Y");
			setTimeout(function (){
				// 收球
				$(".zjdl").addClass("none").removeClass("dila_Y");
				$(".zjdl").children("span").removeAttr('class');
				fallTimes++
				fallBall()
			},2500);
		},1500);
	}
}
// 顯示開獎視窗
const showMessage = () => {
	let data = drawResult.substring( 0 , drawResult.length/3+1 ) + '<br>' 
			+ drawResult.substring( drawResult.length/3+1,2*drawResult.length/3) + '<br>' 
			+ drawResult.substring( 2*drawResult.length/3,drawResult.length)
		
	$("#message").html('編號'+cycleNo+":"+"<br>"+data+"")
	$("#jianpin_one").show();
}
// 顯示倒數
let showCountDown = () => {
	$("#jianpin_one").show();
	let checkoutTimes = 0
	let timeout5 = window.setInterval((async() => {
		// 拿號碼
		checkoutTimes++
		$("#message").html((10 - checkoutTimes))
		if(checkoutTimes === 10) {
			clearInterval(timeout5)
			$("#jianpin_one").hide();
		}
	} ), 1000);
}

// 開獎動作
const play = () => {
	fallTimes = 0
	$("#jianpin_one em img").click()
	// 滾球動畫
	for(i=1;i<=allNum;i++){
		$(".qiu_"+i).removeClass("diaol_"+i);
		$(".qiu_"+i).addClass("wieyi_"+i);
	};

	// 掉球動畫
	fallBall()
	
	// 結束動畫	
	setTimeout(function (){
		for(i=1;i<=allNum;i++){
			$(".qiu_"+i).removeClass("wieyi_"+i);
		}

		showMessage()
		
		// 收球動畫
		$(".zjdl").addClass("none").removeClass("dila_Y");
		$(".zjdl").children("span").removeAttr('class');

	},90000);
}



// 判斷時間
const timeSample = ['0-0','5-0','10-0','15-0','20-0','25-0','30-0','35-0','40-0','45-0','50-0','55-0']
const timeCountdown = ['59-50','4-50','9-50','14-50','19-50','24-50','29-50','34-50','39-50','44-50','49-50','54-50']
const judgeTime = () => {
	let now = new Date()
	let seconds = now.getSeconds()
	let mins = now.getMinutes()
	let hours = now.getHours()
	let time = mins + '-' + seconds
	// console.log('======================')
	// console.log('time',time)
	// console.log(timeSample.includes(time))
	return timeSample.includes(time)
}
// 判斷倒數時間
const judgeCountdown = () => {
	let now = new Date()
	let seconds = now.getSeconds()
	let mins = now.getMinutes()
	let hours = now.getHours()
	let time = mins + '-' + seconds
	console.log('======================')
	console.log('time',time)
	// console.log(timeSample.includes(time))
	return timeCountdown.includes(time)
}
// 確認API改變
let checkNum = () => {
	
	let checkoutTimes = 0
	let timeout3 = window.setInterval((async() => {
		// 拿號碼
		await getNum()
		checkoutTimes++
		if(openStatus) {
			play()
			clearInterval(timeout3)
		}
		// console.log('checkoutTimes',checkoutTimes)
		if(checkoutTimes === 60) clearInterval(timeout3)
	} ), 5000);
}


$(document).ready((e) =>{
	init()
	// console.log('ready')
	//關閉結果畫面
	$("#jianpin_one em img").click(function(){
		$("#jianpin_one").hide();
		}
	);
	
	setTimeout(function (){
		showMessage()
		// play()
	},1500);

	//  version 1
	// let timeout1 = window.setInterval((async() => {
	// 	// 拿號碼
	// 	await getNum()
	// 	if(openStatus) {
	// 		play()
	// 	}
	// } ), 60000);

	// version 2
	// let timeout2 = window.setInterval((async() => {
	// 	if(judgeTime()) {
	// 		await getNum()
	// 		if(openStatus) {
	// 			play()
	// 		}
	// 	}
	// } ), 1000);


	let timeout4 = window.setInterval((async() => {
		
		if(judgeCountdown()) {
			showCountDown()
		}

		if(judgeTime()) {
			await getNum()
			checkNum()
		}
	} ), 1000);
	

});

</script>
</body>
</html>